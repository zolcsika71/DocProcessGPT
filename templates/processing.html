<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing PDF</title>
    <link rel="stylesheet" href="{{ url_for('serve_static', filename='styles.css') }}">
    <style>
        .progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            margin: 20px 0;
        }
        .progress-bar {
            width: 0;
            height: 30px;
            background-color: #4CAF50;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }
        #status-details {
            margin-top: 20px;
            font-style: italic;
        }
        .error-message {
            color: #ff0000;
            font-weight: bold;
        }
        .try-again-btn {
            display: none;
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #log-container {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Processing PDF</h1>
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <p id="status">Processing your PDF file, please wait...</p>
        <p id="status-details"></p>
        <div id="result"></div>
        <button id="try-again-btn" class="try-again-btn" onclick="location.reload();">Try Again</button>
        <div id="log-container"></div>
    </div>
    <script>
        console.log("Processing page loaded");
        let attempts = 0;
        const maxAttempts = 360; // 6 minutes timeout (1 second * 360 attempts)
        const timeoutDuration = 360000; // 6 minutes timeout

        function updateProgressBar(percentage) {
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = percentage + '%';
            console.log(`Progress updated: ${percentage}%`);
        }

        function showError(message) {
            document.getElementById('status').innerHTML = `<span class="error-message">Error: ${message}</span>`;
            document.getElementById('try-again-btn').style.display = 'inline-block';
        }

        function checkStatus() {
            console.log("Checking status... Attempt: " + (attempts + 1));
            fetch('/process_status/{{ filename }}')
                .then(response => {
                    console.log("Status check response received");
                    return response.json();
                })
                .then(data => {
                    console.log("Status check response:", data);
                    if (data.status === 'complete') {
                        updateProgressBar(100);
                        document.getElementById('status').textContent = 'Processing complete!';
                        document.getElementById('status-details').textContent = 'Your PDF has been successfully processed.';
                        document.getElementById('result').innerHTML = `<a href="/processed/${data.filename}" download>Download processed text</a>`;
                    } else if (data.status === 'error') {
                        updateProgressBar(100);
                        showError(data.details);
                        document.getElementById('status-details').textContent = 'An error occurred during processing.';
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        updateProgressBar(data.progress);
                        document.getElementById('status').textContent = `Processing your PDF file, please wait... (${attempts}/${maxAttempts})`;
                        document.getElementById('status-details').textContent = data.details || 'Extracting and preprocessing text...';
                        setTimeout(checkStatus, 1000);
                    } else {
                        updateProgressBar(100);
                        showError('Processing timed out. Please try again.');
                        document.getElementById('status-details').textContent = 'The process took too long to complete.';
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                    updateProgressBar(100);
                    showError('An error occurred while processing the PDF.');
                    document.getElementById('status-details').textContent = 'There was a problem communicating with the server.';
                });
        }

        function fetchLatestLogs() {
            fetch('/latest_logs')
                .then(response => response.json())
                .then(data => {
                    const logContainer = document.getElementById('log-container');
                    logContainer.innerHTML = data.logs.join('<br>');
                    logContainer.scrollTop = logContainer.scrollHeight;
                })
                .catch(error => console.error('Error fetching logs:', error));
        }

        // Start the status check and log fetching
        checkStatus();
        setInterval(fetchLatestLogs, 5000); // Fetch logs every 5 seconds

        // Set a timeout for the entire process
        setTimeout(() => {
            if (document.getElementById('status').textContent.includes('Processing')) {
                updateProgressBar(100);
                showError('Processing timed out. Please try again.');
                document.getElementById('status-details').textContent = 'The process took too long to complete.';
            }
        }, timeoutDuration);
    </script>
</body>
</html>
